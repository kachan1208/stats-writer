FROM golang:1.12 AS build
ARG GIT_BRANCH
ARG GIT_COMMIT
ARG GO_SERVICE_IMPORT_PATH
ARG GO111MODULE

ENV GIT_BRANCH=$GIT_BRANCH
ENV GIT_COMMIT=$GIT_COMMIT
ENV GO_SERVICE_IMPORT_PATH=$GO_SERVICE_IMPORT_PATH
ENV GO111MODULE=$GO111MODULE

RUN echo $GO_SERVICE_IMPORT_PATH
RUN mkdir -p $GO_SERVICE_IMPORT_PATH/
WORKDIR $GO_SERVICE_IMPORT_PATH
COPY . $GO_SERVICE_IMPORT_PATH

RUN make build


FROM scratch
ARG GO_SERVICE_IMPORT_PATH
COPY --from=build $GO_SERVICE_IMPORT_PATH/stats-writer /stats-writer
USER nobody
ENTRYPOINT ["/stats-writer"]
